<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SQL Editor</title>
  <style>
    html, body {
      height: 100%; margin: 0; padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #f5f6fa;
      overflow: hidden;
    }
    .header {
      padding: 16px;
      background: #2a5298;
      color: white; text-align: center;
    }
    .editor-container {
      height: calc(100vh - 60px);
      position: relative;
    }
    #container {
      width: 100%; height: 100%;
    }
    .status-bar {
      position: absolute; bottom: 0; left: 0; right: 0;
      background: #f1f3f4; padding: 4px 12px;
      font-size: 12px; color: #555;
      border-top: 1px solid #ddd;
    }
  </style>
  <script src="https://unpkg.com/monaco-editor@0.38.0/min/vs/loader.js"></script>
</head>
<body>
  <div class="header">
    <h2>SQL Editor</h2>
    <!-- <p>Press Ctrl+Enter (or Cmd+Enter) to execute</p> -->
  </div>
  <div class="editor-container">
    <div id="container"></div>
    <div class="status-bar"><span id="line-col">Ln 1, Col 1</span></div>
  </div>

  <script>
    require.config({ paths: { 'vs': 'https://unpkg.com/monaco-editor@0.38.0/min/vs' } });

    require(['vs/editor/editor.main'], function() {
      const editor = monaco.editor.create(document.getElementById('container'), {
        value: `-- Welcome to SQL Editor
-- Type query and press Ctrl+Enter
SELECT * FROM my_table LIMIT 10;`,
        language: 'sql',
        theme: 'vs',
        minimap: { enabled: false },
        fontSize: 14,
        automaticLayout: true
      });

      function updateLineCol() {
        const pos = editor.getPosition();
        document.getElementById('line-col').textContent = `Ln ${pos.lineNumber}, Col ${pos.column}`;
      }
      editor.onDidChangeCursorPosition(updateLineCol);

      editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.Enter, function() {
        const query = editor.getValue();
        window.parent.postMessage({ source: "sqlEditor", type: "sql:run", value: query }, "*");
      });

      window.addEventListener("message", (event) => {
        const data = event.data || {};
        if (data.type === "sql:set") {
          editor.setValue(data.value || "");
        } else if (data.type === "sql:results") {
          console.log("Query Results from Retool:", data.results);
        }
      });

      monaco.languages.registerCompletionItemProvider('sql', {
        provideCompletionItems: () => {
          const suggestions = [
            { label: 'SELECT', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'SELECT ', detail: 'Select columns from a table' },
            { label: 'FROM', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'FROM ', detail: 'Specify source table' },
            { label: 'WHERE', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'WHERE ', detail: 'Filter rows' },
            { label: 'GROUP BY', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'GROUP BY ', detail: 'Group rows by columns' },
            { label: 'HAVING', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'HAVING ', detail: 'Filter groups' },
            { label: 'ORDER BY', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'ORDER BY ', detail: 'Sort result set' },
            { label: 'LIMIT', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'LIMIT ', detail: 'Limit number of rows' },
            { label: 'INSERT INTO', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'INSERT INTO ', detail: 'Insert new rows' },
            { label: 'UPDATE', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'UPDATE ', detail: 'Update existing rows' },
            { label: 'DELETE', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'DELETE ', detail: 'Delete rows' },
            { label: 'JOIN', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'JOIN ', detail: 'Join tables' },
            { label: 'INNER JOIN', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'INNER JOIN ', detail: 'Return rows with matches in both tables' },
            { label: 'LEFT JOIN', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'LEFT JOIN ', detail: 'Return all rows from left table' },
            { label: 'RIGHT JOIN', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'RIGHT JOIN ', detail: 'Return all rows from right table' },
            { label: 'FULL JOIN', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'FULL JOIN ', detail: 'Return rows when there is a match in one of the tables' },
            { label: 'COUNT', kind: monaco.languages.CompletionItemKind.Function, insertText: 'COUNT(${1:*})', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, detail: 'Count rows' },
            { label: 'SUM', kind: monaco.languages.CompletionItemKind.Function, insertText: 'SUM(${1:column})', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, detail: 'Sum column values' },
            { label: 'AVG', kind: monaco.languages.CompletionItemKind.Function, insertText: 'AVG(${1:column})', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, detail: 'Average column values' },
            { label: 'MAX', kind: monaco.languages.CompletionItemKind.Function, insertText: 'MAX(${1:column})', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, detail: 'Maximum value' },
            { label: 'MIN', kind: monaco.languages.CompletionItemKind.Function, insertText: 'MIN(${1:column})', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, detail: 'Minimum value' }
          ];
          return { suggestions: suggestions };
        }
      });
    });
  </script>
</body>
</html>